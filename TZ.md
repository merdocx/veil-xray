# Техническое задание: Xray VLESS+Reality сервер с API управлением

> ⚠️ **ИСТОРИЧЕСКИЙ ДОКУМЕНТ**  
> Это первоначальное техническое задание проекта. Большинство требований реализовано.  
> **Для актуальной информации используйте:**
> - [README.md](README.md) - основная документация
> - [API_DOCUMENTATION.md](API_DOCUMENTATION.md) - документация API
> - [CHANGELOG.md](CHANGELOG.md) - история изменений
> - [HTTPS_SETUP.md](HTTPS_SETUP.md) - инструкции по настройке HTTPS

## 1. Общее описание проекта

Разработка сервера VPN на базе Xray с протоколом VLESS+Reality и REST API для управления пользователями и мониторинга трафика.

**Домен:** veil-bear.ru  
**Целевая аудитория:** ~100 пользователей  
**Приоритет:** Надежность и стабильность VPN соединений

---

## 2. Технические требования

### 2.1. Инфраструктура

- **Протокол:** VLESS + Reality
- **База данных:** SQLite
- **Домен:** veil-bear.ru (делегирован на сервер)
- **HTTPS:** Обязательно настроен для API и Reality
- **Операционная система:** Linux (Ubuntu/Debian)

### 2.2. Оптимизация под мобильные клиенты

- Оптимизация конфигурации Xray под приложение **v2raytun** для iOS и Android
- Минимизация задержек и оптимизация буферов
- Поддержка мобильных сетей (3G/4G/5G, Wi-Fi)

---

## 3. Функциональные требования

### 3.1. API Endpoints

#### 3.1.1. Создание ключа
- **Метод:** `POST /api/keys`
- **Описание:** Создает новый пользовательский ключ для VPN
- **Параметры запроса:**
  - `name` (опционально): Имя пользователя/ключа
- **Ответ:**
  - `key_id`: Уникальный идентификатор ключа
  - `uuid`: UUID для VLESS конфигурации
  - `short_id`: Short ID для Reality (8 символов)
  - `created_at`: Время создания
- **Требования:**
  - Ключ должен быть добавлен в Xray **без перезагрузки** сервиса
  - Использовать API Xray для динамического управления

#### 3.1.2. Удаление ключа
- **Метод:** `DELETE /api/keys/{key_id}`
- **Описание:** Удаляет пользовательский ключ
- **Параметры:**
  - `key_id`: Идентификатор ключа
- **Ответ:**
  - `success`: Статус операции
  - `message`: Сообщение о результате
- **Требования:**
  - Ключ должен быть удален из Xray **без перезагрузки** сервиса
  - Активные соединения должны быть корректно завершены

#### 3.1.3. Получение текущего трафика по ключу
- **Метод:** `GET /api/keys/{key_id}/traffic`
- **Описание:** Возвращает статистику трафика для указанного ключа
- **Параметры:**
  - `key_id`: Идентификатор ключа
- **Ответ:**
  - `key_id`: Идентификатор ключа
  - `upload`: Загружено байт (за все время)
  - `download`: Скачано байт (за все время)
  - `total`: Общий трафик в байтах
  - `last_updated`: Время последнего обновления статистики
- **Требования:**
  - Данные должны обновляться в реальном времени
  - Использовать статистику из Xray API

#### 3.1.4. Получение готовой VLESS ссылки
- **Метод:** `GET /api/keys/{key_id}/link`
- **Описание:** Возвращает готовую VLESS ссылку для импорта в клиент
- **Параметры:**
  - `key_id`: Идентификатор ключа
- **Ответ:**
  - `key_id`: Идентификатор ключа
  - `vless_link`: Готовая VLESS ссылка в формате `vless://...`
- **Требования:**
  - Ссылка должна быть оптимизирована для v2raytun
  - Должна включать все необходимые параметры Reality

### 3.2. Дополнительные API endpoints (опционально)

- `GET /api/keys` - Список всех ключей
- `GET /api/keys/{key_id}` - Информация о конкретном ключе

---

## 4. Требования к базе данных

### 4.1. Структура SQLite

**Таблица `keys`:**
- `id` (INTEGER PRIMARY KEY): Уникальный идентификатор
- `uuid` (TEXT UNIQUE): UUID для VLESS
- `short_id` (TEXT UNIQUE): Short ID для Reality (8 символов)
- `name` (TEXT): Имя ключа/пользователя
- `created_at` (INTEGER): Timestamp создания
- `is_active` (INTEGER): Флаг активности (0/1)
- `last_used_at` (INTEGER, NULLABLE): Время последнего использования

**Таблица `traffic_stats`:**
- `id` (INTEGER PRIMARY KEY): Уникальный идентификатор
- `key_id` (INTEGER): Ссылка на ключ
- `upload` (INTEGER): Загружено байт
- `download` (INTEGER): Скачано байт
- `updated_at` (INTEGER): Время последнего обновления
- Индекс на `key_id` для быстрого поиска

### 4.2. Оптимизация для ~100 пользователей

- Использование индексов на часто запрашиваемых полях
- Регулярная очистка старых записей статистики (опционально)
- Простая структура без излишних нормализаций

---

## 5. Конфигурация Xray

### 5.1. Reality настройки

- **Server Name:** veil-bear.ru
- **SNI:** microsoft.com (фиксированный для всех ключей)
  - Популярный и часто посещаемый домен
  - Обеспечивает хорошую маскировку трафика как обычный HTTPS
  - Согласован с Dest для оптимальной работы
- **Fingerprint (FP):** chrome (фиксированный для всех ключей)
  - Оптимальный выбор для мобильных клиентов (Chrome широко используется на iOS/Android)
  - Большая доля рынка делает трафик менее подозрительным
  - Обеспечивает хорошую совместимость с v2raytun
- **Short IDs:** Генерируются автоматически для каждого ключа (8 символов, хранятся в базе данных)
- **Dest:** www.microsoft.com:443 (сайт-приманка, согласован с SNI)
  - Крупный и надежный сервис
  - Обеспечивает стабильное соединение для маскировки

### 5.2. Оптимизация для мобильных клиентов

- Настройка буферов для мобильных сетей
- Оптимизация таймаутов соединения
- Поддержка быстрого переподключения
- Минимизация overhead протокола

### 5.3. Динамическое управление

- Использование Xray API для добавления/удаления пользователей
- Endpoint: `POST /api/v1/users/add` и `POST /api/v1/users/remove`
- Конфигурация должна поддерживать динамические изменения

### 5.4. Разделение параметров: уникальные и универсальные

#### Уникальные параметры для каждого ключа

Эти параметры генерируются индивидуально для каждого пользователя и хранятся в базе данных:

- **UUID** (TEXT UNIQUE): Уникальный идентификатор пользователя для VLESS протокола
  - Генерируется при создании ключа
  - Используется для аутентификации пользователя
  - Хранится в таблице `keys` в поле `uuid`

- **Short ID** (TEXT UNIQUE, 8 символов): Уникальный короткий идентификатор для Reality
  - Генерируется автоматически при создании ключа (8 символов)
  - Используется для маршрутизации трафика в Reality
  - Хранится в таблице `keys` в поле `short_id`
  - Должен быть уникальным для каждого ключа

#### Универсальные параметры (общие для всех ключей)

Эти параметры одинаковы для всех пользователей и настраиваются один раз на сервере:

**Сетевые параметры:**
- **Server Address:** veil-bear.ru (IP адрес сервера)
- **Port:** Порт сервера (например, 443)
- **Protocol:** vless

**Reality параметры:**
- **Server Name (SNI):** microsoft.com (фиксированный для всех ключей)
- **Fingerprint (FP):** chrome (фиксированный для всех ключей)
  - Оптимальный выбор для мобильных клиентов (Chrome широко используется на iOS/Android)
  - Обеспечивает хорошую маскировку трафика
- **Public Key:** Публичный ключ сервера для Reality (генерируется один раз)
- **Private Key:** Приватный ключ сервера (хранится только на сервере, не передается клиентам)
- **Dest:** www.microsoft.com:443 (сайт-приманка, согласован с SNI для оптимальной маскировки)
- **Server Names:** Список разрешенных SNI (включает microsoft.com и www.microsoft.com)

**Протокольные параметры:**
- **Flow:** "none" или "xtls-rprx-vision" (для VLESS)
- **Encryption:** "none" (для VLESS)
- **Network:** "tcp" (для Reality)
- **Security:** "reality"

**Хранение универсальных параметров:**
- Хранятся в конфигурационном файле Xray (`config.json`)
- Могут быть вынесены в отдельный конфигурационный файл приложения
- Не должны храниться в базе данных для каждого ключа

**При генерации VLESS ссылки:**
- Универсальные параметры берутся из конфигурации сервера
- Уникальные параметры (UUID, Short ID) берутся из базы данных для конкретного ключа
- Short ID извлекается из поля `short_id` таблицы `keys` (8 символов)
- Ссылка формируется путем объединения всех параметров

---

## 6. Контроль трафика

### 6.1. Требования

- **Только запись:** Статистика трафика записывается в базу данных
- **Без ограничений:** Никаких лимитов трафика не устанавливается
- **Без уведомлений:** Система не отправляет уведомления при достижении каких-либо порогов
- **Мониторинг:** Данные собираются для статистики и анализа

### 6.2. Реализация

- Использование Xray Stats API для получения статистики
- Периодическое обновление данных в базе (например, каждые 60 секунд)
- Хранение накопительной статистики (upload/download за все время)

---

## 7. Безопасность

### 7.1. API Security

- Аутентификация API (токен или ключ)
- Rate limiting для предотвращения злоупотреблений
- Валидация всех входных данных
- HTTPS для всех API запросов

### 7.2. Серверная безопасность

- Firewall правила
- Регулярные обновления Xray
- Мониторинг подозрительной активности
- Логирование критических операций

---

## 8. Развертывание и инфраструктура

### 8.1. HTTPS настройка

- SSL сертификат для veil-bear.ru (Let's Encrypt)
- Автоматическое обновление сертификата
- Настройка Nginx/Caddy как reverse proxy для API

### 8.2. Структура проекта

```
/
├── api/              # API сервер (Python FastAPI)
├── xray/             # Конфигурация Xray
├── database/         # SQLite база данных
├── scripts/          # Скрипты развертывания
├── config/           # Конфигурационные файлы
└── README.md         # Документация
```

---

## 9. Технический стек

### 9.1. API сервер

**Python (FastAPI)**
- Простота разработки
- Хорошая поддержка SQLite
- Легкая интеграция с Xray API
- Автоматическая генерация документации API (Swagger/OpenAPI)
- Высокая производительность благодаря асинхронности

### 9.2. Xray

- Версия: Последняя стабильная версия Xray-core
- Конфигурация: JSON формат
- API: Встроенный API сервер Xray

---

## 10. Производительность и масштабируемость

### 10.1. Оптимизация для ~100 пользователей

- Простая архитектура без излишних абстракций
- Прямое взаимодействие с Xray API
- Минимальное количество зависимостей
- Эффективные запросы к SQLite

### 10.2. Мониторинг

- Логирование ошибок
- Метрики производительности API
- Мониторинг использования ресурсов сервера

---

## 11. Критерии приемки

1. ✅ API позволяет создавать ключи без перезагрузки Xray
2. ✅ API позволяет удалять ключи без перезагрузки Xray
3. ✅ Статистика трафика обновляется в реальном времени
4. ✅ VLESS ссылки корректно работают в v2raytun на iOS/Android
5. ✅ HTTPS настроен и работает для veil-bear.ru
6. ✅ Система стабильно работает с ~100 пользователями
7. ✅ Трафик записывается без ограничений и уведомлений
8. ✅ Все операции выполняются через SQLite базу данных

---

## 12. Дополнительные требования

### 12.1. Надежность

- Автоматический перезапуск сервисов при сбоях (systemd/supervisor)
- Резервное копирование базы данных
- Логирование всех критических операций

### 12.2. Документация

- README с инструкциями по развертыванию
- API документация (Swagger/OpenAPI)
- Примеры использования API

---

## 13. Этапы разработки

1. **Этап 1:** Настройка инфраструктуры (домен, HTTPS, Xray)
2. **Этап 2:** Разработка API для управления ключами
3. **Этап 3:** Интеграция с Xray API (динамическое управление)
4. **Этап 4:** Реализация мониторинга трафика
5. **Этап 5:** Оптимизация под мобильные клиенты
6. **Этап 6:** Тестирование и отладка
7. **Этап 7:** Развертывание и документация

---

## 14. Ограничения и исключения

- Не требуется система уведомлений пользователей
- Не требуется система лимитов трафика
- Не требуется веб-интерфейс (только API)
- Не требуется поддержка других протоколов кроме VLESS+Reality
- Не требуется мультисерверная архитектура

---

**Версия документа:** 1.0  
**Дата создания:** 2024  
**Статус:** Готово к разработке

