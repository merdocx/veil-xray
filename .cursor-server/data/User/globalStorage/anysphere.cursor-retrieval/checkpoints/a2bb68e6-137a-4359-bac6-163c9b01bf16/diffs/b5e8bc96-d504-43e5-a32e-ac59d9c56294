{"fsPath":"/root/TZ.md","fileUuid":"b5e8bc96-d504-43e5-a32e-ac59d9c56294","fileSizeBytes":8503,"numLines":305,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":306,"addedLines":["# Техническое задание: Xray VLESS+Reality сервер с API управлением","","## 1. Общее описание проекта","","Разработка сервера VPN на базе Xray с протоколом VLESS+Reality и REST API для управления пользователями и мониторинга трафика.","","**Домен:** veil-bear.ru  ","**Целевая аудитория:** ~100 пользователей  ","**Приоритет:** Надежность и стабильность VPN соединений","","---","","## 2. Технические требования","","### 2.1. Инфраструктура","","- **Протокол:** VLESS + Reality","- **База данных:** SQLite","- **Домен:** veil-bear.ru (делегирован на сервер)","- **HTTPS:** Обязательно настроен для API и Reality","- **Операционная система:** Linux (Ubuntu/Debian)","","### 2.2. Оптимизация под мобильные клиенты","","- Оптимизация конфигурации Xray под приложение **v2raytun** для iOS и Android","- Минимизация задержек и оптимизация буферов","- Поддержка мобильных сетей (3G/4G/5G, Wi-Fi)","","---","","## 3. Функциональные требования","","### 3.1. API Endpoints","","#### 3.1.1. Создание ключа","- **Метод:** `POST /api/keys`","- **Описание:** Создает новый пользовательский ключ для VPN","- **Параметры запроса:**","  - `name` (опционально): Имя пользователя/ключа","  - `expires_at` (опционально): Дата истечения ключа (timestamp)","- **Ответ:**","  - `key_id`: Уникальный идентификатор ключа","  - `uuid`: UUID для VLESS конфигурации","  - `created_at`: Время создания","- **Требования:**","  - Ключ должен быть добавлен в Xray **без перезагрузки** сервиса","  - Использовать API Xray для динамического управления","","#### 3.1.2. Удаление ключа","- **Метод:** `DELETE /api/keys/{key_id}`","- **Описание:** Удаляет пользовательский ключ","- **Параметры:**","  - `key_id`: Идентификатор ключа","- **Ответ:**","  - `success`: Статус операции","  - `message`: Сообщение о результате","- **Требования:**","  - Ключ должен быть удален из Xray **без перезагрузки** сервиса","  - Активные соединения должны быть корректно завершены","","#### 3.1.3. Получение текущего трафика по ключу","- **Метод:** `GET /api/keys/{key_id}/traffic`","- **Описание:** Возвращает статистику трафика для указанного ключа","- **Параметры:**","  - `key_id`: Идентификатор ключа","- **Ответ:**","  - `key_id`: Идентификатор ключа","  - `upload`: Загружено байт (за все время)","  - `download`: Скачано байт (за все время)","  - `total`: Общий трафик в байтах","  - `last_updated`: Время последнего обновления статистики","- **Требования:**","  - Данные должны обновляться в реальном времени","  - Использовать статистику из Xray API","","#### 3.1.4. Получение готовой VLESS ссылки","- **Метод:** `GET /api/keys/{key_id}/link`","- **Описание:** Возвращает готовую VLESS ссылку для импорта в клиент","- **Параметры:**","  - `key_id`: Идентификатор ключа","- **Ответ:**","  - `key_id`: Идентификатор ключа","  - `vless_link`: Готовая VLESS ссылка в формате `vless://...`","  - `qr_code` (опционально): Base64 изображение QR-кода для мобильных клиентов","- **Требования:**","  - Ссылка должна быть оптимизирована для v2raytun","  - Должна включать все необходимые параметры Reality","","### 3.2. Дополнительные API endpoints (опционально)","","- `GET /api/keys` - Список всех ключей","- `GET /api/keys/{key_id}` - Информация о конкретном ключе","- `GET /api/stats` - Общая статистика сервера","","---","","## 4. Требования к базе данных","","### 4.1. Структура SQLite","","**Таблица `keys`:**","- `id` (INTEGER PRIMARY KEY): Уникальный идентификатор","- `uuid` (TEXT UNIQUE): UUID для VLESS","- `name` (TEXT): Имя ключа/пользователя","- `created_at` (INTEGER): Timestamp создания","- `expires_at` (INTEGER, NULLABLE): Timestamp истечения","- `is_active` (INTEGER): Флаг активности (0/1)","- `last_used_at` (INTEGER, NULLABLE): Время последнего использования","","**Таблица `traffic_stats`:**","- `id` (INTEGER PRIMARY KEY): Уникальный идентификатор","- `key_id` (INTEGER): Ссылка на ключ","- `upload` (INTEGER): Загружено байт","- `download` (INTEGER): Скачано байт","- `updated_at` (INTEGER): Время последнего обновления","- Индекс на `key_id` для быстрого поиска","","### 4.2. Оптимизация для ~100 пользователей","","- Использование индексов на часто запрашиваемых полях","- Регулярная очистка старых записей статистики (опционально)","- Простая структура без излишних нормализаций","","---","","## 5. Конфигурация Xray","","### 5.1. Reality настройки","","- **Server Name:** veil-bear.ru","- **Short IDs:** Генерируются автоматически для каждого ключа","- **Dest:** Настроенный сайт-приманка","- **SNI:** veil-bear.ru","","### 5.2. Оптимизация для мобильных клиентов","","- Настройка буферов для мобильных сетей","- Оптимизация таймаутов соединения","- Поддержка быстрого переподключения","- Минимизация overhead протокола","","### 5.3. Динамическое управление","","- Использование Xray API для добавления/удаления пользователей","- Endpoint: `POST /api/v1/users/add` и `POST /api/v1/users/remove`","- Конфигурация должна поддерживать динамические изменения","","---","","## 6. Контроль трафика","","### 6.1. Требования","","- **Только запись:** Статистика трафика записывается в базу данных","- **Без ограничений:** Никаких лимитов трафика не устанавливается","- **Без уведомлений:** Система не отправляет уведомления при достижении каких-либо порогов","- **Мониторинг:** Данные собираются для статистики и анализа","","### 6.2. Реализация","","- Использование Xray Stats API для получения статистики","- Периодическое обновление данных в базе (например, каждые 60 секунд)","- Хранение накопительной статистики (upload/download за все время)","","---","","## 7. Безопасность","","### 7.1. API Security","","- Аутентификация API (токен или ключ)","- Rate limiting для предотвращения злоупотреблений","- Валидация всех входных данных","- HTTPS для всех API запросов","","### 7.2. Серверная безопасность","","- Firewall правила","- Регулярные обновления Xray","- Мониторинг подозрительной активности","- Логирование критических операций","","---","","## 8. Развертывание и инфраструктура","","### 8.1. HTTPS настройка","","- SSL сертификат для veil-bear.ru (Let's Encrypt)","- Автоматическое обновление сертификата","- Настройка Nginx/Caddy как reverse proxy для API","","### 8.2. Структура проекта","","```","/","├── api/              # API сервер (Python/Go/Node.js)","├── xray/             # Конфигурация Xray","├── database/         # SQLite база данных","├── scripts/          # Скрипты развертывания","├── config/           # Конфигурационные файлы","└── README.md         # Документация","```","","---","","## 9. Технический стек (рекомендации)","","### 9.1. API сервер","","**Вариант 1: Python (FastAPI)**","- Простота разработки","- Хорошая поддержка SQLite","- Легкая интеграция с Xray API","","**Вариант 2: Go**","- Высокая производительность","- Низкое потребление ресурсов","- Хорошая поддержка конкурентности","","**Вариант 3: Node.js (Express)**","- Быстрая разработка","- Большое количество библиотек","","### 9.2. Xray","","- Версия: Последняя стабильная версия Xray-core","- Конфигурация: JSON формат","- API: Встроенный API сервер Xray","","---","","## 10. Производительность и масштабируемость","","### 10.1. Оптимизация для ~100 пользователей","","- Простая архитектура без излишних абстракций","- Прямое взаимодействие с Xray API","- Минимальное количество зависимостей","- Эффективные запросы к SQLite","","### 10.2. Мониторинг","","- Логирование ошибок","- Метрики производительности API","- Мониторинг использования ресурсов сервера","","---","","## 11. Критерии приемки","","1. ✅ API позволяет создавать ключи без перезагрузки Xray","2. ✅ API позволяет удалять ключи без перезагрузки Xray","3. ✅ Статистика трафика обновляется в реальном времени","4. ✅ VLESS ссылки корректно работают в v2raytun на iOS/Android","5. ✅ HTTPS настроен и работает для veil-bear.ru","6. ✅ Система стабильно работает с ~100 пользователями","7. ✅ Трафик записывается без ограничений и уведомлений","8. ✅ Все операции выполняются через SQLite базу данных","","---","","## 12. Дополнительные требования","","### 12.1. Надежность","","- Автоматический перезапуск сервисов при сбоях (systemd/supervisor)","- Резервное копирование базы данных","- Логирование всех критических операций","","### 12.2. Документация","","- README с инструкциями по развертыванию","- API документация (Swagger/OpenAPI)","- Примеры использования API","","---","","## 13. Этапы разработки","","1. **Этап 1:** Настройка инфраструктуры (домен, HTTPS, Xray)","2. **Этап 2:** Разработка API для управления ключами","3. **Этап 3:** Интеграция с Xray API (динамическое управление)","4. **Этап 4:** Реализация мониторинга трафика","5. **Этап 5:** Оптимизация под мобильные клиенты","6. **Этап 6:** Тестирование и отладка","7. **Этап 7:** Развертывание и документация","","---","","## 14. Ограничения и исключения","","- Не требуется система уведомлений пользователей","- Не требуется система лимитов трафика","- Не требуется веб-интерфейс (только API)","- Не требуется поддержка других протоколов кроме VLESS+Reality","- Не требуется мультисерверная архитектура","","---","","**Версия документа:** 1.0  ","**Дата создания:** 2024  ","**Статус:** Готово к разработке","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000001,1000003,1000001,1000004,1000005,1000006,1000001,1000007,1000001,1000008,1000001,1000009,1000001,1000010,1000011,1000012,1000013,1000014,1000001,1000015,1000001,1000016,1000017,1000018,1000001,1000007,1000001,1000019,1000001,1000020,1000001,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000001,1000034,1000035,1000036,1000037,1000038,1000027,1000039,1000040,1000031,1000041,1000042,1000001,1000043,1000044,1000045,1000037,1000038,1000027,1000038,1000046,1000047,1000048,1000049,1000031,1000050,1000051,1000001,1000052,1000053,1000054,1000037,1000038,1000027,1000038,1000055,1000056,1000031,1000057,1000058,1000001,1000059,1000001,1000060,1000061,1000062,1000001,1000007,1000001,1000063,1000001,1000064,1000001,1000065,1000066,1000067,1000068,1000069,1000070,1000071,1000072,1000001,1000073,1000066,1000074,1000075,1000076,1000077,1000078,1000001,1000079,1000001,1000080,1000081,1000082,1000001,1000007,1000001,1000083,1000001,1000084,1000001,1000085,1000086,1000087,1000088,1000001,1000089,1000001,1000090,1000091,1000092,1000093,1000001,1000094,1000001,1000095,1000096,1000097,1000001,1000007,1000001,1000098,1000001,1000099,1000001,1000100,1000101,1000102,1000103,1000001,1000104,1000001,1000105,1000106,1000107,1000001,1000007,1000001,1000108,1000001,1000109,1000001,1000110,1000111,1000112,1000113,1000001,1000114,1000001,1000115,1000116,1000117,1000118,1000001,1000007,1000001,1000119,1000001,1000120,1000001,1000121,1000122,1000123,1000001,1000124,1000001,1000125,1000126,1000127,1000128,1000129,1000130,1000131,1000132,1000125,1000001,1000007,1000001,1000133,1000001,1000134,1000001,1000135,1000136,1000137,1000138,1000001,1000139,1000140,1000141,1000142,1000001,1000143,1000144,1000145,1000001,1000146,1000001,1000147,1000148,1000149,1000001,1000007,1000001,1000150,1000001,1000151,1000001,1000152,1000153,1000154,1000155,1000001,1000156,1000001,1000157,1000158,1000159,1000001,1000007,1000001,1000160,1000001,1000161,1000162,1000163,1000164,1000165,1000166,1000167,1000168,1000001,1000007,1000001,1000169,1000001,1000170,1000001,1000171,1000172,1000173,1000001,1000174,1000001,1000175,1000176,1000177,1000001,1000007,1000001,1000178,1000001,1000179,1000180,1000181,1000182,1000183,1000184,1000185,1000001,1000007,1000001,1000186,1000001,1000187,1000188,1000189,1000190,1000191,1000001,1000007,1000001,1000192,1000193,1000194,1000001,1000001]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}