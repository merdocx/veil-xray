# Миграция на единый Short ID

## Обзор

Система была обновлена для использования единого общего `short_id` для всех пользователей вместо индивидуальных `short_id` для каждого ключа. Это позволяет избежать перезагрузки Xray при создании или удалении ключей.

## Изменения

### 1. Настройки (`config/settings.py`)
- Добавлен параметр `reality_common_short_id` (по умолчанию: `"7bb45050"`)
- Можно изменить через переменную окружения `REALITY_COMMON_SHORT_ID` в файле `.env`

### 2. База данных (`api/database.py`)
- Удалено уникальное ограничение (`unique=True`) с поля `short_id` в таблице `keys`
- Теперь все ключи могут иметь одинаковый `short_id`

### 3. API (`api/main.py`)
- При создании ключей используется общий `short_id` из настроек вместо генерации индивидуального
- Все ответы API возвращают общий `short_id` вместо индивидуального
- Синхронизация пользователей использует общий `short_id`

### 4. Конфигурация Xray (`api/xray_config.py`)
- Добавлен метод `ensure_common_short_id()` для гарантии наличия общего `short_id` в конфигурации Xray
- Метод автоматически добавляет общий `short_id` в массив `shortIds` в `realitySettings`, если его там нет
- При старте API сервера автоматически проверяется и обновляется конфигурация Xray

### 5. VLESS ссылки (`api/utils.py`)
- Уже использовали общий `short_id` из настроек (без изменений)

## Миграция существующих баз данных

Для обновления существующих баз данных выполните:

```bash
python3 scripts/migrate_to_common_shortid.py
```

Скрипт:
- Обновит все существующие ключи, установив им общий `short_id`
- Автоматически удалит уникальный индекс `ix_keys_short_id` из базы данных (для SQLite и других СУБД)

## Преимущества

1. **Нет перезагрузки Xray**: При создании/удалении ключей не требуется перезагрузка Xray, так как `short_id` не меняется
2. **Мгновенная доступность**: Новые ключи работают сразу после создания
3. **Упрощенная конфигурация**: Один `short_id` для всех пользователей упрощает управление

## Важные замечания

1. **Конфигурация Xray**: При первом запуске после обновления общий `short_id` автоматически добавляется в конфигурацию Xray
2. **Существующие ключи**: Все существующие ключи будут использовать общий `short_id` после миграции
3. **VLESS ссылки**: Все VLESS ссылки используют один и тот же `short_id`, что является нормальным поведением

## Настройка

Чтобы изменить общий `short_id`, добавьте в файл `.env`:

```env
REALITY_COMMON_SHORT_ID=your_custom_short_id_here
```

`short_id` должен быть строкой из 8 шестнадцатеричных символов (например, `"7bb45050"`).

